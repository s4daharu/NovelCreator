(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();function ct(){try{const e=localStorage.getItem("novels");return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load novels from localStorage:",e),$({title:"Data Load Error",message:"Could not load your saved novels. Your data might be corrupted, or localStorage is unavailable. Any new work might not be saved correctly if the issue persists.",okText:"OK"}),[]}}function _(e){try{localStorage.setItem("novels",JSON.stringify(e))}catch(o){console.error("Failed to save novels to localStorage:",o),$({title:"Save Error",message:"Could not save your changes. Please ensure localStorage is enabled and not full. Further edits might be lost if this issue is not resolved.",okText:"OK"})}}const qe="novelCreatorAppSettings";function oe(){const e={defaultAuthor:"",autoOpenDrawerDesktop:!0,theme:"dark"};try{const o=localStorage.getItem(qe),t=o?JSON.parse(o):{};return["light","dark"].includes(t.theme)||(t.theme=e.theme),{...e,...t}}catch(o){return console.error("Failed to load app settings from localStorage:",o),e}}function Ze(e){try{localStorage.setItem(qe,JSON.stringify(e))}catch(o){console.error("Failed to save app settings to localStorage:",o)}}function X(e){return e?e.replace(/[^\w\s.-]/g,"").trim().replace(/\s+/g,"_").replace(/__+/g,"_").substring(0,100):"untitled"}function dt(e){return new Promise((o,t)=>{if(!e){o(null);return}const n=new FileReader;n.onload=a=>o(a.target.result),n.onerror=a=>{console.error("File to DataURL error:",a),t(a)},n.readAsDataURL(e)})}function ut(e){if(!e)return"";const o=document.createElement("div");o.innerHTML=e,o.querySelectorAll("p, h1, h2, h3, h4, h5, h6, div, li, blockquote, pre, hr").forEach(n=>{if(n.tagName==="HR")n.parentNode.insertBefore(document.createTextNode(`
---
`),n.nextSibling);else{const a=document.createTextNode(`
`);n.parentNode.insertBefore(a,n.nextSibling)}}),o.querySelectorAll("br").forEach(n=>{n.parentNode.insertBefore(document.createTextNode(`
`),n)});let t=o.textContent||o.innerText||"";return t=t.replace(/\n\s*\n\s*\n+/g,`

`),t.trim()}const We='button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';function ge({title:e="Enter value:",placeholder:o="",initialValue:t=""}){return new Promise(n=>{const a=document.activeElement,r=document.createElement("div");r.className="modal-overlay",r.innerHTML=`
      <div class="modal" role="dialog" aria-labelledby="promptTitle" aria-modal="true">
        <h2 id="promptTitle">${e}</h2>
        <input type="text" id="promptInput" placeholder="${o}" value="${t}" class="w-full p-2 mb-4 bg-color-input-bg border border-color-border rounded text-color-onSurface">
        <div class="actions">
          <button id="promptCancelBtn" class="btn btn-secondary">Cancel</button>
          <button id="promptOkBtn" class="btn btn-primary">OK</button>
        </div>
      </div>
    `,document.body.appendChild(r),document.body.classList.add("body-modal-open"),requestAnimationFrame(()=>{r.classList.add("active")});const i=r.querySelector(".modal"),m=r.querySelector("#promptInput"),p=r.querySelector("#promptOkBtn"),l=r.querySelector("#promptCancelBtn"),f=Array.from(i.querySelectorAll(We)).filter(v=>v.offsetParent!==null),s=f[0]||m,c=f[f.length-1]||p;m.focus(),m.select();const d=()=>{const v=m.value.trim();T(),n(v||null)},u=()=>{T(),n(null)},h=v=>{if(v.key==="Enter"&&v.target===m)v.preventDefault(),d();else if(v.key==="Escape")u();else if(v.key==="Tab"){if(f.length===0){v.preventDefault();return}v.shiftKey?document.activeElement===s&&(v.preventDefault(),c.focus()):document.activeElement===c&&(v.preventDefault(),s.focus())}};p.addEventListener("click",d),l.addEventListener("click",u),r.addEventListener("click",v=>{v.target===r&&u()}),r.addEventListener("keydown",h);function T(){r.classList.remove("active"),document.body.classList.remove("body-modal-open"),p.removeEventListener("click",d),l.removeEventListener("click",u),r.removeEventListener("click",u),r.removeEventListener("keydown",h),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r),a&&typeof a.focus=="function"&&a.focus()},200)}})}function $({title:e="Are you sure?",message:o="",okText:t="OK",cancelText:n="Cancel"}){return new Promise(a=>{const r=document.activeElement,i=document.createElement("div");i.className="modal-overlay",i.innerHTML=`
      <div class="modal" role="alertdialog" aria-labelledby="confirmTitle" aria-describedby="confirmMessage" aria-modal="true">
        <h2 id="confirmTitle">${e}</h2>
        ${o?`<p id="confirmMessage" class="modal-message">${o}</p>`:""}
        <div class="actions">
          <button id="confirmCancelBtn" class="btn btn-secondary">${n}</button>
          <button id="confirmOkBtn" class="btn btn-primary">${t}</button>
        </div>
      </div>
    `,document.body.appendChild(i),document.body.classList.add("body-modal-open"),requestAnimationFrame(()=>{i.classList.add("active")});const m=i.querySelector(".modal"),p=i.querySelector("#confirmOkBtn"),l=i.querySelector("#confirmCancelBtn"),f=Array.from(m.querySelectorAll(We)).filter(v=>v.offsetParent!==null),s=f[0]||l,c=f[f.length-1]||p;p.focus();const d=()=>{T(),a(!0)},u=()=>{T(),a(!1)},h=v=>{if(v.key==="Enter"&&document.activeElement!==l)v.preventDefault(),d();else if(v.key==="Escape")u();else if(v.key==="Tab"){if(f.length===0){v.preventDefault();return}v.shiftKey?document.activeElement===s&&(v.preventDefault(),c.focus()):document.activeElement===c&&(v.preventDefault(),s.focus())}};p.addEventListener("click",d),l.addEventListener("click",u),i.addEventListener("click",v=>{v.target===i&&u()}),i.addEventListener("keydown",h);function T(){i.classList.remove("active"),document.body.classList.remove("body-modal-open"),p.removeEventListener("click",d),l.removeEventListener("click",u),i.removeEventListener("click",u),i.removeEventListener("keydown",h),setTimeout(()=>{document.body.contains(i)&&document.body.removeChild(i),r&&typeof r.focus=="function"&&r.focus()},200)}})}function ue(e,o){let t;function n(...a){const r=()=>{clearTimeout(t),e(...a)};clearTimeout(t),t=setTimeout(r,o),n._timeoutId=t}return n._timeoutId=null,n}function mt(e){if(!e)return"";const o=new Date(e);if(isNaN(o.getTime()))return"";const n=Math.round((new Date-o)/1e3),a=Math.round(n/60),r=Math.round(a/60),i=Math.round(r/24),m=Math.round(i/7),p=Math.round(i/30.44),l=Math.round(i/365.25);return n<5?"just now":n<60?`${n} seconds ago`:a<60?`${a} minute${a>1?"s":""} ago`:r<24?`${r} hour${r>1?"s":""} ago`:i===1?"Yesterday":i<7?`${i} day${i>1?"s":""} ago`:m===1?"1 week ago":p<1?`${m} week${m>1?"s":""} ago`:p<12?`${p} month${p>1?"s":""} ago`:l===1?"1 year ago":`${l} year${l>1?"s":""} ago`}function pt(e){if(!e)return"";const o=new Date(e);if(isNaN(o.getTime()))return"";const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),t.getDate()),a=new Date(n);a.setDate(n.getDate()-1);const r=new Date(o.getFullYear(),o.getMonth(),o.getDate()),i=o.toLocaleTimeString([],{hour:"numeric",minute:"2-digit"});if(r.getTime()===n.getTime())return`at ${i}`;if(r.getTime()===a.getTime())return`Yesterday at ${i}`;{const m=o.getMonth()+1,p=o.getDate(),l=o.getFullYear().toString().slice(-2);return`on ${m}/${p}/${l} at ${i}`}}let w=[],k=null,x=null,y=null,G=null,S={app:null,editor:null,chapterList:null},A=!1,ne=null;const ft="app",xe="pageTitle",Pe="exportBtn",me="menuBtn",Ue="themeToggleBtn",ht="themeIconSun",gt="themeIconMoon",Ve="settingsBtn",Y="chapterDrawer",Ke="contentArea",Ne="novelTitleDisplay",we="editNovelTitleBtn",pe="chapterList",be="addChapterBtn",ve="editor",vt="editorStatusBar",Ee="wordCountDisplay",Le="characterCountDisplay",Ce="characterCountWithSpacesDisplay",ke="backToLibraryBtn",yt="saveStatus",Ye="lastSavedStatus",ce="activeChapterTitleDisplay",Ge="novelSearchInput",ze="novelSearchClearBtn",Je="chapterSearchInput",xt="chapterSearchClearBtn";let He,J=oe(),M="",V="",B,j,F,z;window.addEventListener("DOMContentLoaded",()=>{J=oe(),Xe(J.theme),w=ct().map(t=>({...t,createdAt:t.createdAt||new Date(0).toISOString(),updatedAt:t.updatedAt||t.createdAt||new Date(0).toISOString(),language:t.language||"en-US",chapters:t.chapters?t.chapters.map(n=>({...n,createdAt:n.createdAt||new Date(0).toISOString(),updatedAt:n.updatedAt||n.createdAt||new Date(0).toISOString()})):[]}));const e=new URLSearchParams(window.location.search),o=e.get("novelId");if(o&&w.some(t=>t.id===o)){k=o;const t=e.get("chapterId");if(t){const n=w.find(a=>a.id===k);n&&n.chapters.some(a=>a.id===t)&&(x=t)}Oe()}else Q();bt(),Ut()});function Xe(e){const o=document.documentElement,t=document.getElementById(ht),n=document.getElementById(gt);e==="light"?(o.classList.remove("dark"),t&&t.classList.remove("hidden"),n&&n.classList.add("hidden")):(o.classList.add("dark"),t&&t.classList.add("hidden"),n&&n.classList.remove("hidden")),J.theme=e}function wt(){const e=J.theme==="dark"?"light":"dark";Xe(e),Ze(J)}function te(e,o){const t=new URL(window.location);e?(t.searchParams.set("novelId",e),o?t.searchParams.set("chapterId",o):t.searchParams.delete("chapterId")):(t.searchParams.delete("novelId"),t.searchParams.delete("chapterId"),E("","clear"),O()),window.history.pushState({novelId:e,chapterId:o},"",t)}function O(){const e=document.getElementById(Ye);if(!e)return;ne&&k&&x?(e.textContent=`Last saved ${pt(ne)}`,e.classList.remove("hidden")):(e.textContent="",e.classList.add("hidden"))}function E(e="",o="info",t=2500){const n=document.getElementById(yt),a=document.getElementById(Ye);if(n)if(clearTimeout(He),n.textContent=e,n.classList.remove("text-color-text-secondary","text-[var(--secondary)]","text-color-error","text-yellow-400"),n.classList.remove("scale-100","scale-105"),n.setAttribute("aria-live","polite"),e){n.classList.remove("opacity-0"),n.classList.add("opacity-100");let r=!1;switch(o){case"saving":n.classList.add("text-color-text-secondary","scale-100"),n.setAttribute("aria-live","off"),r=!0,a&&a.classList.add("hidden");break;case"success":n.classList.add("text-[var(--secondary)]","scale-105"),n.setAttribute("aria-live","assertive"),a&&O();break;case"error":n.classList.add("text-color-error","scale-100"),n.setAttribute("aria-live","assertive"),a&&O();break;case"warning":n.classList.add("text-yellow-400","scale-100"),r=!0,a&&O();break;default:n.classList.add("text-color-text-secondary","scale-100"),a&&O();break}!r&&o!=="clear"?He=setTimeout(()=>{n.classList.remove("opacity-100","scale-105"),n.classList.add("opacity-0"),n.setAttribute("aria-live","off"),a&&O()},t):o==="clear"&&(n.classList.add("opacity-0"),n.setAttribute("aria-live","off"),a&&O())}else n.classList.add("opacity-0"),n.setAttribute("aria-live","off"),a&&O()}function K(e){const o=w.find(t=>t.id===e);o&&(o.updatedAt=new Date().toISOString())}async function Me(){return A?await $({title:"Unsaved Changes",message:"You have unsaved changes. Are you sure you want to leave? Your changes will be lost.",okText:"Leave",cancelText:"Stay"}):!0}function bt(){const e=document.getElementById(me);e.addEventListener("click",kt),e.setAttribute("aria-controls",Y),document.getElementById(Ue).addEventListener("click",wt),document.getElementById(Pe).addEventListener("click",Pt),document.getElementById(ke).addEventListener("click",async()=>{await Me()&&(await de(),k=null,x=null,A=!1,Q())}),window.addEventListener("resize",ue(()=>{k&&window.innerWidth>=768&&oe().autoOpenDrawerDesktop&&Se()},200)),window.addEventListener("beforeunload",t=>{k&&A&&(t.preventDefault(),t.returnValue="")})}function Et(){const e=oe(),o=document.activeElement,t=document.createElement("div");t.id="settingsModalOverlay",t.className="modal-overlay",document.body.appendChild(t),t.innerHTML=`
        <div class="modal" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
            <h2 id="settingsModalTitle">Application Settings</h2>

            <div class="mb-4">
                <label for="settingDefaultAuthor" class="block text-sm font-medium text-color-onSurface mb-1">Default Author Name</label>
                <input type="text" id="settingDefaultAuthor" value="${e.defaultAuthor||""}" placeholder="Your Pen Name" class="w-full p-2 bg-color-input-bg border border-color-border rounded text-color-onSurface">
            </div>

            <div class="mb-6">
                <div class="flex items-center">
                    <input type="checkbox" id="settingAutoOpenDrawerDesktop" class="h-4 w-4 text-color-accent bg-gray-700 border-gray-600 rounded focus:ring-color-accent focus:ring-2" ${e.autoOpenDrawerDesktop?"checked":""}>
                    <label for="settingAutoOpenDrawerDesktop" class="ml-2 block text-sm text-color-onSurface select-none">
                        Automatically open chapter drawer on desktop when a novel is loaded
                    </label>
                </div>
            </div>

            <div class="actions">
                <button id="settingsCancelBtn" class="btn btn-secondary">Cancel</button>
                <button id="settingsSaveBtn" class="btn btn-primary">Save Settings</button>
            </div>
        </div>
    `,document.body.classList.add("body-modal-open"),requestAnimationFrame(()=>{t.classList.add("active")});const n=t.querySelector(".modal"),a=t.querySelector("#settingsSaveBtn"),r=t.querySelector("#settingsCancelBtn"),i=t.querySelector("#settingDefaultAuthor"),m=t.querySelector("#settingAutoOpenDrawerDesktop");i.focus(),i.select();const p=Array.from(n.querySelectorAll('button, input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(h=>h.offsetParent!==null),l=p[0],f=p[p.length-1],s=()=>{const h={...J,defaultAuthor:i.value.trim(),autoOpenDrawerDesktop:m.checked};Ze(h),J=h,E("Settings saved ✓","success"),u()},c=()=>{u()},d=h=>{h.key==="Enter"&&h.target===i?(h.preventDefault(),s()):h.key==="Escape"?c():h.key==="Tab"&&(h.shiftKey?document.activeElement===l&&(h.preventDefault(),f.focus()):document.activeElement===f&&(h.preventDefault(),l.focus()))};a.addEventListener("click",s),r.addEventListener("click",c),t.addEventListener("click",h=>{h.target===t&&c()}),t.addEventListener("keydown",d);function u(){t.classList.remove("active"),document.body.classList.remove("body-modal-open"),a.removeEventListener("click",s),r.removeEventListener("click",c),t.removeEventListener("click",c),t.removeEventListener("keydown",d),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t),o&&typeof o.focus=="function"&&o.focus()},200)}}function Lt(){B=document.getElementById(Ge),j=document.getElementById(ze),B&&(B.value=M,B.addEventListener("input",()=>{M=B.value.trim().toLowerCase(),j&&j.classList.toggle("hidden",!M),Q()}),B.addEventListener("keydown",e=>{e.key==="Escape"&&(M="",B.value="",j&&j.classList.add("hidden"),Q())})),j&&(j.classList.toggle("hidden",!M),j.addEventListener("click",()=>{M="",B&&(B.value=""),j.classList.add("hidden"),Q(),B&&B.focus()}))}function Q(){te(null,null),_e(),A=!1,ne=null,O(),document.getElementById(xe).innerText="My Novels",document.getElementById(Pe).classList.add("hidden");const e=document.getElementById(me);e.classList.add("md:hidden","hidden"),e.setAttribute("aria-expanded","false"),document.getElementById(Y).classList.remove("open","translate-x-0"),document.getElementById(Y).classList.add("md:hidden","-translate-x-full"),document.getElementById(ke).classList.add("hidden"),document.getElementById(we).classList.add("hidden");const o=document.getElementById(Ve);o.classList.remove("hidden"),o.onclick=Et,document.getElementById(Ue).classList.remove("hidden");const t=document.getElementById(Ke),n=`
    <div class="relative w-full sm:max-w-xs">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>
        </div>
        <input type="text" id="${Ge}" placeholder="Search novels..." class="block w-full pl-10 pr-8 py-2.5 border border-color-border rounded-md bg-color-input-bg text-color-onSurface placeholder-color-text-secondary focus:ring-color-accent focus:border-color-accent sm:text-sm">
        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <button id="${ze}" class="text-gray-500 dark:text-gray-400 hover:text-color-onSurface hidden" aria-label="Clear novel search">
                 <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
    </div>`,a=`
    <button id="restoreNovelsBtn" title="Restore Novels" class="bg-gray-600 dark:bg-gray-700 text-white px-3 py-2.5 rounded-md hover:bg-gray-500 dark:hover:bg-gray-600 transition-opacity text-xs font-medium flex items-center gap-x-1.5">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.002 0A4.5 4.5 0 0117.25 18H6.75z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25A2.25 2.25 0 0017.25 12a2.25 2.25 0 00-2.25 2.25m4.5 0v6.75a2.25 2.25 0 01-2.25 2.25H6.75a2.25 2.25 0 01-2.25-2.25v-6.75a2.25 2.25 0 012.25-2.25h10.5a2.25 2.25 0 012.25 2.25z" /></svg>Restore
    </button>
    <input type="file" id="restoreFileInput" class="hidden" accept=".json">
    <button id="backupNovelsBtn" title="Backup All Novels" class="bg-gray-600 dark:bg-gray-700 text-white px-3 py-2.5 rounded-md hover:bg-gray-500 dark:hover:bg-gray-600 transition-opacity text-xs font-medium flex items-center gap-x-1.5">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.002 0A4.5 4.5 0 0117.25 15H6.75z" /></svg>Backup All
    </button>
    <button id="newNovelBtn" class="bg-color-accent text-white px-4 py-2.5 rounded-md hover:opacity-80 transition-opacity text-sm font-medium flex items-center justify-center gap-x-1.5 sm:gap-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>New Novel
    </button>`,r=w.filter(l=>M?l.title&&l.title.toLowerCase().includes(M)||l.author&&l.author.toLowerCase().includes(M):!0);if(w.length===0){t.innerHTML=`
        <div class="max-w-3xl mx-auto py-6 sm:py-8 flex flex-col items-center justify-center text-center h-full px-4">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-20 h-20 text-gray-500 dark:text-gray-400 mb-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0V12m0-3.75V6.042M12 12a2.25 2.25 0 0 0-2.25 2.25M12 12a2.25 2.25 0 0 1 2.25 2.25M12 12V9.75M12 9.75A2.25 2.25 0 0 1 9.75 7.5M12 9.75A2.25 2.25 0 0 0 14.25 7.5M12 15v2.25A2.25 2.25 0 0 0 14.25 19.5M12 15v2.25A2.25 2.25 0 0 1 9.75 19.5" />
            </svg>
            <h2 class="text-2xl font-semibold text-color-onBackground mb-3">Your Bookshelf Awaits</h2>
            <p class="text-color-text-secondary mb-8 max-w-md">Ready to bring your stories to life? Every great novel starts with a single word. Let's begin yours.</p>
            <button id="createFirstNovelBtnInPlaceholder" class="bg-color-accent text-white px-6 py-3 rounded-md hover:opacity-80 transition-opacity text-base font-medium flex items-center justify-center gap-x-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>Create Your First Novel
            </button>
            <div class="mt-12 flex items-center gap-x-2">
                ${a.replace(/<button id="newNovelBtn".*?<\/button>/,"")}
            </div>
        </div>
    `;const l=document.getElementById("createFirstNovelBtnInPlaceholder");l&&(l.onclick=Fe,l.focus())}else{t.innerHTML=`
        <div class="max-w-3xl mx-auto py-6 sm:py-8">
          <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 px-4 sm:px-0">
            <div class="w-full sm:w-auto flex-shrink-0">${n}</div>
            <div class="flex items-center gap-x-1.5 sm:gap-x-2 self-stretch sm:self-center justify-end flex-grow">
                ${a}
            </div>
          </div>
          <ul id="novelList" class="space-y-3 px-4 sm:px-0">
          </ul>
        </div>
      `;const l=document.getElementById("novelList");if(r.length===0&&M){const s=document.createElement("li");s.className="text-center text-color-text-secondary py-8",s.innerHTML=`<p>No novels match "<strong>${M}</strong>".</p><p class="text-xs mt-1">Try a different search term or clear the search.</p>`,l.appendChild(s)}else r.sort((s,c)=>new Date(c.updatedAt||c.createdAt)-new Date(s.updatedAt||s.createdAt)).forEach(s=>{const c=document.createElement("li");c.className="bg-color-surface p-4 rounded-lg shadow hover:shadow-md transition-shadow flex justify-between items-center cursor-pointer group",c.setAttribute("aria-label",`Open novel: ${s.title||"Untitled Novel"}`),c.setAttribute("role","button"),c.tabIndex=0;const d=s.updatedAt||s.createdAt,u=mt(d),h=d===s.createdAt&&s.updatedAt===s.createdAt||!s.updatedAt?"Created":"Updated",T=s.coverDataURL?`<img src="${s.coverDataURL}" alt="Cover for ${s.title||"Untitled Novel"}" class="w-10 h-14 object-cover rounded-sm mr-3 flex-shrink-0">`:`<div class="w-10 h-14 bg-gray-200 dark:bg-gray-700 rounded-sm mr-3 flex items-center justify-center text-gray-400 dark:text-gray-500 flex-shrink-0">
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6-2.292m0 0A9.043 9.043 0 0 0 9 7.5a9.043 9.043 0 0 0-3 1.5m0 0c0 1.657 1.343 3 3 3s3-1.343 3-3m0 0c0-1.657-1.343-3-3-3s-3 1.343-3 3m0 0-2.08.69A8.966 8.966 0 0 0 3 13.5v2.25m18 0v-2.25c0-.871-.239-1.683-.666-2.411l-2.08-.69M12 15V6.042" /></svg>
               </div>`;c.innerHTML=`
            <div class="flex items-center min-w-0">
                ${T}
                <div class="truncate">
                  <h3 class="font-semibold text-color-onSurface text-lg truncate pointer-events-none">${s.title||"Untitled Novel"}</h3>
                  <p class="text-xs text-color-text-secondary pointer-events-none">Chapters: ${s.chapters.length} | ${h}: ${u||new Date(d).toLocaleDateString()}</p>
                </div>
            </div>
            <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                <button data-action="open" aria-label="Open ${s.title||"Untitled Novel"}" class="text-sm bg-color-accent/80 text-white px-3 py-1.5 rounded group-hover:bg-color-accent group-focus-within:bg-color-accent transition-colors">Open</button>
                <button data-action="delete" title="Delete Novel" aria-label="Delete ${s.title||"Untitled Novel"}" class="text-color-error p-1.5 rounded-full hover:bg-color-error/20 group-focus-within:bg-color-error/20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 pointer-events-none"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75H4.5a.75.75 0 0 0 0 1.5h11a.75.75 0 0 0 0-1.5H14A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.531.096 2.182.275a.75.75 0 0 0 .541-.941A4.527 4.527 0 0 0 10 3c-.84 0-1.531.096-2.182.275a.75.75 0 0 0 .541.941A4.527 4.527 0 0 0 10 4ZM4.5 6.5A.75.75 0 0 0 3.75 7.25v7.5A2.75 2.75 0 0 0 6.5 17.5h7a2.75 2.75 0 0 0 2.75-2.75v-7.5A.75.75 0 0 0 15.5 6.5h-11Z" clip-rule="evenodd" /></svg>
                </button>
            </div>
          `;const v=async()=>{k=s.id,Oe()};c.querySelector('button[data-action="open"]').addEventListener("click",L=>{L.stopPropagation(),v()}),c.querySelector('button[data-action="delete"]').addEventListener("click",async L=>{L.stopPropagation();const ee=s.chapters.length>0?`Are you sure you want to permanently delete the novel "${s.title||"Untitled Novel"}" and its ${s.chapters.length} chapter(s)? This action cannot be undone.`:`Are you sure you want to permanently delete the novel "${s.title||"Untitled Novel"}"? This action cannot be undone.`;await $({title:"Delete Novel",message:ee,okText:"Delete",cancelText:"Cancel"})&&(w=w.filter(Ie=>Ie.id!==s.id),_(w),Q())}),c.addEventListener("click",v),c.addEventListener("keydown",L=>{(L.key==="Enter"||L.key===" ")&&(L.preventDefault(),v())}),l.appendChild(c)});l.children.length>0&&!l.dataset.keyboardNavAttached&&r.length>0?(l.dataset.keyboardNavAttached="true",l.addEventListener("keydown",s=>{const c=Array.from(l.querySelectorAll('li[tabindex="0"]'));if(!c.length)return;let d=c.findIndex(u=>u===document.activeElement);if(["ArrowDown","ArrowUp","Home","End"].includes(s.key)){if(s.preventDefault(),d===-1&&(s.key==="ArrowDown"||s.key==="ArrowUp")){c[0].focus();return}s.key==="ArrowDown"?d=(d+1)%c.length:s.key==="ArrowUp"?d=(d-1+c.length)%c.length:s.key==="Home"?d=0:s.key==="End"&&(d=c.length-1),c[d].focus()}})):(l.children.length===0||r.length===0)&&delete l.dataset.keyboardNavAttached;const f=document.getElementById("newNovelBtn");f&&f.addEventListener("click",Fe)}const i=document.getElementById("backupNovelsBtn"),m=document.getElementById("restoreNovelsBtn"),p=document.getElementById("restoreFileInput");if(i&&i.addEventListener("click",()=>{const f=`novels_backup_${new Date().toISOString().replace(/[:.]/g,"-")}.json`,s=JSON.stringify(w,null,2),c=new Blob([s],{type:"application/json"}),d=URL.createObjectURL(c),u=document.createElement("a");u.href=d,u.download=f,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(d),E("All novels backed up!","success")}),m&&p&&(m.addEventListener("click",()=>p.click()),p.addEventListener("change",async l=>{const f=l.target.files[0];if(!f)return;const s=await f.text();try{const c=JSON.parse(s);if(!Array.isArray(c)||!c.every(u=>u&&u.id&&u.title!==void 0&&Array.isArray(u.chapters)&&u.chapters.every(h=>h&&h.id&&h.title!==void 0&&h.order!==void 0&&h.contentHTML!==void 0))){E("Restore failed: Invalid backup file format.","error",4e3),p.value="";return}await $({title:"Restore Novels",message:"Restoring will overwrite all current novels and their chapters. This action cannot be undone. Are you sure you want to continue?",okText:"Restore",cancelText:"Cancel"})&&(w=c.map(u=>({...u,language:u.language||"en-US",createdAt:u.createdAt||new Date(0).toISOString(),updatedAt:u.updatedAt||u.createdAt||new Date(0).toISOString(),chapters:u.chapters.map(h=>({...h,createdAt:h.createdAt||new Date(0).toISOString(),updatedAt:h.updatedAt||h.createdAt||new Date(0).toISOString()}))})),_(w),M="",Q(),E("Novels restored successfully!","success"))}catch(c){console.error("Restore error:",c),E("Restore failed: Could not parse backup file.","error",4e3)}p.value=""})),Lt(),r.length>0){const l=document.querySelector('#novelList li[tabindex="0"]');l&&(!document.activeElement||document.activeElement===document.body||document.activeElement===t)&&l.focus()}else if(w.length===0){const l=document.getElementById("createFirstNovelBtnInPlaceholder");l&&(!document.activeElement||document.activeElement===document.body)&&l.focus()}else M&&r.length===0&&B&&(!document.activeElement||document.activeElement===document.body)&&B.focus()}async function Fe(){const e=await ge({title:"New Novel Title",placeholder:"Enter novel title…"});if(e===null)return;const o=oe(),t=new Date().toISOString(),n={id:crypto.randomUUID(),title:e||"Untitled Novel",author:o.defaultAuthor||"",createdAt:t,updatedAt:t,coverDataURL:null,language:"en-US",chapters:[]};w.push(n),_(w),k=n.id,Oe()}function Ct(e){F=document.getElementById(Je),z=document.getElementById(xt),F&&(F.value=V,F.addEventListener("input",()=>{V=F.value.trim().toLowerCase(),z&&z.classList.toggle("hidden",!V),q(e)}),F.addEventListener("keydown",o=>{o.key==="Escape"&&(V="",F.value="",z&&z.classList.add("hidden"),q(e))})),z&&(z.classList.toggle("hidden",!V),z.addEventListener("click",()=>{V="",F&&(F.value=""),z.classList.add("hidden"),q(e),F&&F.focus()}))}async function Oe(){const e=w.find(n=>n.id===k);if(!e)return Q();J=oe(),M="",B&&(B.value=""),j&&j.classList.add("hidden"),te(e.id,x),A=!1,document.getElementById(xe).innerText=e.title||"Untitled Novel",document.getElementById(Pe).classList.remove("hidden"),document.getElementById(me).classList.remove("hidden","md:hidden"),document.getElementById(Y).classList.remove("md:hidden"),document.getElementById(ke).classList.remove("hidden"),document.getElementById(we).classList.remove("hidden"),document.getElementById(Ve).classList.add("hidden"),document.getElementById(Ue).classList.remove("hidden"),window.innerWidth>=768&&J.autoOpenDrawerDesktop?Se():Ae(),q(e);const t=document.getElementById(Ke);if(t.innerHTML=`
    <h3 id="${ce}" class="text-lg font-semibold mb-3 text-color-onSurface truncate px-1"></h3>
    <div class="flex flex-col h-[calc(100%-2.5rem)]"> <!-- Adjust height if title takes more space -->
      <div id="${ve}" class="outline-none" tabindex="-1"></div> <!-- Placeholder for CKEditor -->
      <div id="${vt}" class="flex-shrink-0 p-2 border-t border-[var(--border-color)] text-xs text-[var(--text-secondary)] flex justify-end items-center gap-x-3">
        <span id="${Le}">Chars: 0</span>
        <span class="text-gray-600 dark:text-gray-400">|</span>
        <span id="${Ce}">Chars (incl. spaces): 0</span>
        <span class="text-gray-600 dark:text-gray-400">|</span>
        <span id="${Ee}">Words: 0</span>
      </div>
    </div>
  `,!e.chapters.length)x=null,Te();else{let n;x&&e.chapters.some(a=>a.id===x)?n=e.chapters.find(a=>a.id===x):(n=e.chapters.sort((a,r)=>a.order-r.order)[0],x=n.id,te(e.id,x)),await le(n)}}function q(e){const o=document.getElementById(Ne);o.innerText=e.title||"Untitled Novel";const t=document.getElementById(we);t.onclick=async()=>{const r=await ge({title:"Edit Novel Title",initialValue:e.title,placeholder:"Enter novel title..."});r!==null&&r!==e.title&&(e.title=r||"Untitled Novel",K(e.id),_(w),E("Novel title updated","success"),document.getElementById(xe).innerText=e.title,o.innerText=e.title)};const n=document.getElementById(pe);n.innerHTML="",delete n.dataset.keyboardNavAttached;const a=e.chapters.filter(r=>V?r.title.toLowerCase().includes(V):!0).sort((r,i)=>r.order-i.order);if(e.chapters.length===0){const r=document.createElement("div");r.className="flex flex-col items-center justify-center text-center p-6 h-full text-color-text-secondary",r.innerHTML=`
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-gray-500 dark:text-gray-400 mb-3">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m9.75 0A2.25 2.25 0 0 0 19.5 2.25m0 0A2.25 2.25 0 0 0 21.75 0M4.5 6.375A2.25 2.25 0 0 1 2.25 4.5m0 0A2.25 2.25 0 0 1 0 2.25m5.625 17.25a2.25 2.25 0 0 1-2.25-2.25V6.375c0-.621.504-1.125 1.125-1.125h12.75c.621 0 1.125.504 1.125 1.125V19.5a2.25 2.25 0 0 1-2.25-2.25M10.5 18.75h3" />
        </svg>
        <p class="text-base font-medium text-color-onSurface mb-1">No Chapters Here</p>
        <p class="text-xs">Tap the "+ New Chapter" button below to add your first one.</p>
    `,n.appendChild(r),G&&(G.destroy(),G=null)}else if(a.length===0&&V){const r=document.createElement("li");r.className="text-center text-color-text-secondary py-8 px-2",r.innerHTML=`<p>No chapters match "<strong>${V}</strong>".</p><p class="text-xs mt-1">Try a different search term or clear the search.</p>`,n.appendChild(r),G&&(G.destroy(),G=null)}else{let r=null;a.forEach(i=>{const m=document.createElement("li");m.dataset.chapterId=i.id,m.className="flex justify-between items-center p-2.5 rounded-md cursor-pointer group hover:bg-color-accent/10",m.setAttribute("role","button"),m.tabIndex=0,m.setAttribute("aria-label",`Open chapter: ${i.order}. ${i.title||"Untitled Chapter"}`),m.innerHTML=`
        <span class="chapter-title truncate flex-1 text-sm flex items-center">
            <svg viewBox="0 0 10 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="drag-handle-icon w-4 h-4 mr-2 text-gray-500 dark:text-gray-400 group-hover:text-color-accent group-[.active-chapter]:text-color-accent transition-colors flex-shrink-0">
                <circle cx="2" cy="2" r="1.5"/> <circle cx="8" cy="2" r="1.5"/>
                <circle cx="2" cy="8" r="1.5"/> <circle cx="8" cy="8" r="1.5"/>
                <circle cx="2" cy="14" r="1.5"/> <circle cx="8" cy="14" r="1.5"/>
            </svg>
            ${i.order}. ${i.title||"Untitled Chapter"}
        </span>
        <button data-action="delete" title="Delete Chapter" aria-label="Delete chapter ${i.title||"Untitled Chapter"}" class="delete-chapter-btn p-1 rounded-full hover:bg-color-error/20 group-focus-within:bg-color-error/20 opacity-60 hover:opacity-100 group-focus-within:opacity-100 transition-opacity">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 pointer-events-none text-color-error">
            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75H4.5a.75.75 0 0 0 0 1.5h11a.75.75 0 0 0 0-1.5H14A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.531.096 2.182.275a.75.75 0 0 0 .541-.941A4.527 4.527 0 0 0 10 3c-.84 0-1.531.096-2.182.275a.75.75 0 0 0 .541.941A4.527 4.527 0 0 0 10 4ZM4.5 6.5A.75.75 0 0 0 3.75 7.25v7.5A2.75 2.75 0 0 0 6.5 17.5h7a2.75 2.75 0 0 0 2.75-2.75v-7.5A.75.75 0 0 0 15.5 6.5h-11Z" clip-rule="evenodd" />
          </svg>
        </button>
      `,n.appendChild(m),i.id===x&&(r=m,m.classList.add("active-chapter","bg-color-accent/15"));const p=async()=>{await Me()&&(x!==i.id&&(await de(),x=i.id,te(e.id,i.id),await le(i),n.querySelectorAll("li.active-chapter").forEach(l=>l.classList.remove("active-chapter","bg-color-accent/15")),m.classList.add("active-chapter","bg-color-accent/15")),je())};m.addEventListener("click",l=>{l.target.closest('button[data-action="delete"]')||p()}),m.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),document.activeElement===m&&p())}),m.querySelector('[data-action="delete"]').addEventListener("click",async l=>{var c;if(l.stopPropagation(),!await $({title:"Delete Chapter",message:`Are you sure you want to delete chapter “${i.title||"Untitled Chapter"}”? This cannot be undone.`,okText:"Delete",cancelText:"Cancel"}))return;const s=x===i.id;s&&(A=!1),e.chapters=e.chapters.filter(d=>d.id!==i.id),se(e.chapters),K(e.id),_(w),E("Chapter deleted","success",1500),q(e),ot(),s&&(x=((c=e.chapters.sort((d,u)=>d.order-u.order)[0])==null?void 0:c.id)||null,te(e.id,x),x?await le(e.chapters.find(d=>d.id===x)):Te())})}),r&&typeof r.scrollIntoView=="function"&&requestAnimationFrame(()=>r.scrollIntoView({behavior:"smooth",block:"nearest"})),n.children.length>0&&!n.dataset.keyboardNavAttached&&(n.dataset.keyboardNavAttached="true",n.addEventListener("keydown",i=>{const m=Array.from(n.querySelectorAll('li[tabindex="0"]'));if(!m.length)return;let p=m.findIndex(l=>l===document.activeElement);if(["ArrowDown","ArrowUp","Home","End"].includes(i.key)){if(i.preventDefault(),p===-1&&(i.key==="ArrowDown"||i.key==="ArrowUp")){m[0].focus();return}i.key==="ArrowDown"?p=(p+1)%m.length:i.key==="ArrowUp"?p=(p-1+m.length)%m.length:i.key==="Home"?p=0:i.key==="End"&&(p=m.length-1),m[p]&&m[p].focus()}})),G&&G.destroy(),G=Sortable.create(n,{animation:150,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",handle:".chapter-title",onEnd:i=>{const m=e.chapters.splice(i.oldDraggableIndex,1)[0];e.chapters.splice(i.newDraggableIndex,0,m),se(e.chapters),K(e.id),_(w),E("Order saved","success",1500),n.classList.add("list-reordered-flash"),setTimeout(()=>{n.classList.remove("list-reordered-flash"),q(e)},700)}})}document.getElementById(be).onclick=async()=>{if(!await Me())return;const r=e.chapters.length+1,i=await ge({title:"New Chapter Title",placeholder:`Chapter ${r}`});if(i===null)return;const m=new Date().toISOString(),p={id:crypto.randomUUID(),title:i||`Chapter ${r}`,order:r,contentHTML:"<p></p>",createdAt:m,updatedAt:m};e.chapters.push(p),K(e.id),_(w),E("Chapter created","success",1500);const l=x;x=p.id,te(e.id,x),q(e),l!==p.id&&l!==null&&await de(),await le(p),je()},_t(),Ct(e)}function se(e){e.sort((o,t)=>o.order-t.order).forEach((o,t)=>{o.order=t+1})}function Se(){const e=document.getElementById(Y),o=document.getElementById(me);e.classList.add("open","translate-x-0"),e.classList.remove("-translate-x-full"),o.setAttribute("aria-expanded","true"),setTimeout(()=>{const t=document.getElementById(Je),n=document.getElementById(we),a=document.getElementById(ke),r=document.querySelector(`#${pe} li[tabindex="0"]`),i=document.getElementById(be);t&&getComputedStyle(t).display!=="none"&&t.offsetParent!==null?t.focus():n&&getComputedStyle(n).display!=="none"&&n.offsetParent!==null?n.focus():a&&getComputedStyle(a).display!=="none"&&a.offsetParent!==null?a.focus():r?r.focus():i&&getComputedStyle(i).display!=="none"&&i.offsetParent!==null&&i.focus()},100)}function Ae(){const e=document.getElementById(Y),o=document.getElementById(me),t=document.activeElement;e.classList.remove("open","translate-x-0"),e.classList.add("-translate-x-full"),o.setAttribute("aria-expanded","false"),o&&getComputedStyle(o).display!=="none"&&o.offsetParent!==null&&(e.contains(t)||t===e||t===o)&&o.focus()}function kt(){const e=document.getElementById(Y);e.classList.contains("translate-x-0")||e.classList.contains("open")?Ae():Se()}function je(){window.innerWidth<768&&Ae()}function Qe(e){if(!e)return 0;const o=document.createElement("div");o.innerHTML=e;const n=(o.textContent||o.innerText||"").match(/\b[\w'-]+\b/g);return n?n.length:0}function ye(e,o=!0){if(!e)return 0;const t=document.createElement("div");t.innerHTML=e;let n=t.textContent||t.innerText||"";return o&&(n=n.replace(/\s/g,"")),n.length}const St=ue(()=>{if(y){const e=y.getData(),o=Qe(e),t=document.getElementById(Ee);t&&(t.textContent=`Words: ${o}`)}},300),At=ue(()=>{if(y){const e=y.getData(),o=ye(e),t=document.getElementById(Le);t&&(t.textContent=`Chars: ${o}`)}},300),Tt=ue(()=>{if(y){const e=y.getData(),o=ye(e,!1),t=document.getElementById(Ce);t&&(t.textContent=`Chars (incl. spaces): ${o}`)}},300);async function et(){if(!y||!x||!k)return!1;E("Saving...","saving");const e=w.find(t=>t.id===k);if(!e)return E("Save failed: novel not found","error"),!1;const o=e.chapters.find(t=>t.id===x);return o?(o.contentHTML=y.getData(),o.updatedAt=new Date().toISOString(),K(e.id),_(w),E("Saved ✓","success"),A=!1,ne=new Date,O(),!0):(E("Save failed: chapter not found","error"),A=!0,!1)}const tt=ue(et,1e3);async function le(e){var i,m,p;const o=document.getElementById(ve),t=document.getElementById(ce);o&&(o.innerHTML=`
        <div class="flex items-center justify-center h-full text-color-text-secondary p-8 text-center">
            <svg class="animate-spin w-5 h-5 mr-2 text-color-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>Loading chapter...
        </div>`),t&&(t.textContent="Loading...");const n=document.getElementById(Ee);n&&(n.textContent="Words: 0");const a=document.getElementById(Le);a&&(a.textContent="Chars: 0");const r=document.getElementById(Ce);if(r&&(r.textContent="Chars (incl. spaces): 0"),A=!1,!e){Te();return}if(await _e(),!o){console.error("Editor placeholder element not found after potential destroy"),t&&(t.textContent="Error loading chapter");return}t&&(t.textContent=e.title||"Untitled Chapter");try{y=await ClassicEditor.create(o,{toolbar:["heading","|","bold","italic","underline","strikethrough","|","link","blockQuote","insertTable","codeBlock","|","bulletedList","numberedList","|","undo","redo","|","findAndReplace"],table:{contentToolbar:["tableColumn","tableRow","mergeTableCells"]},codeBlock:{languages:[{language:"plaintext",label:"Plain text"},{language:"javascript",label:"JavaScript"},{language:"python",label:"Python"},{language:"html",label:"HTML"},{language:"css",label:"CSS"},{language:"java",label:"Java"},{language:"c",label:"C"},{language:"cpp",label:"C++"},{language:"php",label:"PHP"},{language:"ruby",label:"Ruby"},{language:"go",label:"Go"},{language:"bash",label:"Bash/Shell"},{language:"sql",label:"SQL"},{language:"json",label:"JSON"},{language:"xml",label:"XML"},{language:"markdown",label:"Markdown"}]},placeholder:"Start writing your chapter here…"}),y&&y.ui&&y.ui.element&&y.ui.element.classList.add("flex-grow","min-h-0","flex","flex-col"),y.setData(e.contentHTML||"<p></p>"),A=!1,y.editing&&typeof y.editing.view.focus=="function"&&y.editing.view.focus(),y.ui.view.editable.element&&Ot(y.ui.view.editable.element);const l=y.getData(),f=Qe(l);n&&(n.textContent=`Words: ${f}`);const s=ye(l);a&&(a.textContent=`Chars: ${s}`);const c=ye(l,!1);r&&(r.textContent=`Chars (incl. spaces): ${c}`),ne=new Date(e.updatedAt),O(),y.model.document.on("change:data",()=>{A=!0,E("Unsaved changes","warning"),tt(),St(),At(),Tt()}),E("","clear"),(p=(m=(i=y==null?void 0:y.ui)==null?void 0:i.view)==null?void 0:m.editable)!=null&&p.element&&requestAnimationFrame(()=>{var d,u,h;(h=(u=(d=y==null?void 0:y.ui)==null?void 0:d.view)==null?void 0:u.editable)!=null&&h.element&&(y.ui.view.editable.element.scrollTop=0)})}catch(l){console.error("CKEditor initialization error:",l);const f=document.getElementById(ve);f&&(f.innerHTML='<p class="text-color-error p-4">Error loading editor. Please try refreshing.</p>'),t&&(t.textContent="Error Loading Chapter"),E("Editor load failed","error"),A=!1,ne=null,O()}}async function de(){return y&&x&&k?(clearTimeout(tt._timeoutId),await et()):!1}async function _e(){if(A&&await de(),nt(),y){try{await y.destroy()}catch(e){console.error("Error destroying editor instance:",e)}y=null}A=!1}function Te(){const e=document.getElementById(ce);_e().then(()=>{const o=document.getElementById(ve);if(o){o.classList.add("flex-grow","min-h-0");const r=w.find(i=>i.id===k);if(r&&r.chapters.length===0){e&&(e.textContent="Write Your First Chapter"),o.innerHTML=`
                <div class="flex flex-col items-center justify-center h-full text-center p-4 text-color-text-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-gray-500 dark:text-gray-400 mb-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                    </svg>
                    <h3 class="text-xl font-semibold text-color-onSurface mb-2">Let's begin your story!</h3>
                    <p class="mb-4 max-w-xs">Every great novel starts with a single chapter. What will yours be about?</p>
                    <button id="createFirstChapterBtnInPlaceholder" class="bg-color-accent text-white px-6 py-2.5 rounded-md hover:opacity-80 transition-opacity font-medium flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                        Create Your First Chapter
                    </button>
                </div>
            `;const i=document.getElementById("createFirstChapterBtnInPlaceholder");i&&(i.onclick=document.getElementById(be).onclick,i.focus())}else e&&(e.textContent="No Chapter Selected"),o.innerHTML='<div class="flex items-center justify-center h-full text-color-text-secondary p-8 text-center"><p>Select a chapter to start editing, or create a new one.</p></div>'}const t=document.getElementById(Ee);t&&(t.textContent="Words: 0");const n=document.getElementById(Le);n&&(n.textContent="Chars: 0");const a=document.getElementById(Ce);a&&(a.textContent="Chars (incl. spaces): 0"),E("","clear"),A=!1,ne=null,O()})}function It(){return`<?xml version="1.0"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`}function Dt(){return`body { font-family: sans-serif; margin: 5%; line-height: 1.5; }
h1, h2, h3, h4, h5, h6 { margin-top: 1.5em; margin-bottom: 0.5em; line-height: 1.2; text-align:left; }
p { margin-top: 0.5em; margin-bottom: 0.5em; text-align:justify; }
img { max-width: 100%; height: auto; display:block; margin: 1em auto; }
div.cover-image-container { width: 100%; height: 100vh; display: flex; align-items: center; justify-content: center; margin:0; padding:0; }
div.cover-image-container img { max-width: 100%; max-height: 100vh; object-fit: contain; }
`}function Bt(e,o){return`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="${o}">
<head>
  <title>Cover</title>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>
<body>
  <div class="cover-image-container">
    <img src="images/${e}" alt="Cover Image"/>
  </div>
</body>
</html>`}function $t(e,o,t,n,a,r){const i=a.map(d=>`<item id="chapter-${d.id}" href="${X(`chapter-${d.order}_${d.title||"chapter-"+d.order}`)}.xhtml" media-type="application/xhtml+xml"/>`).join(`
        `),m=a.map(d=>`<itemref idref="chapter-${d.id}"/>`).join(`
        `);let p="",l="",f="",s="",c="";return r&&(p=`<item id="cover-image" href="images/${r.filename}" media-type="${r.mimeType}"/>`,l='<item id="cover-page" href="cover.xhtml" media-type="application/xhtml+xml"/>',f='<meta name="cover" content="cover-image"/>',s='<itemref idref="cover-page" linear="yes"/>',c='<guide><reference type="cover" title="Cover" href="cover.xhtml"/></guide>'),`<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" unique-identifier="bookid" version="2.0">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opf="http://www.idpf.org/2007/opf">
    <dc:identifier id="bookid">urn:uuid:${e.id}</dc:identifier>
    <dc:title>${o}</dc:title>
    <dc:creator opf:role="aut">${t}</dc:creator>
    <dc:language>${n}</dc:language>
    <dc:publisher>Novel Creator App</dc:publisher>
    <dc:date>${(e.updatedAt||e.createdAt||new Date).toISOString().split("T")[0]}</dc:date>
    ${f}
  </metadata>
  <manifest>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    <item id="css" href="css/style.css" media-type="text/css"/>
    ${p}
    ${l}
    ${i}
  </manifest>
  <spine toc="ncx">
    ${s}
    ${m}
  </spine>
  ${c}
</package>`}function Nt(e,o,t){const n=t.map(a=>`
    <navPoint id="navpoint-${a.order}" playOrder="${a.order}">
      <navLabel><text>${a.title||`Chapter ${a.order}`}</text></navLabel>
      <content src="${X(`chapter-${a.order}_${a.title||"chapter-"+a.order}`)}.xhtml"/>
    </navPoint>`).join("");return`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ncx PUBLIC "-//NISO//DTD ncx 2005-1//EN" "http://www.daisy.org/z3986/2005/ncx-2005-1.dtd">
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head>
    <meta name="dtb:uid" content="urn:uuid:${e.id}"/>
    <meta name="dtb:depth" content="1"/>
    <meta name="dtb:totalPageCount" content="0"/>
    <meta name="dtb:maxPageNumber" content="0"/>
  </head>
  <docTitle><text>${o}</text></docTitle>
  <navMap>${n}
  </navMap>
</ncx>`}function Mt(e,o){const t=e.title||`Chapter ${e.order}`;return`<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="${o}">
<head>
  <title>${t}</title>
  <link rel="stylesheet" type="text/css" href="css/style.css"/>
</head>
<body>
  <h2>${t}</h2>
  ${e.contentHTML||"<p></p>"}
</body>
</html>`}async function Pt(){if(!k)return;await de();const e=w.find(g=>g.id===k);if(!e)return;if(e.chapters.length===0){await $({title:"Export Error",message:"Please add at least one chapter to your novel before exporting.",okText:"OK"});return}const o=document.activeElement;let t=document.getElementById("exportModalOverlay");t&&t.remove(),t=document.createElement("div"),t.id="exportModalOverlay",t.className="modal-overlay";const n=oe(),a=[{value:"en-US",text:"English (US)"},{value:"en-GB",text:"English (UK)"},{value:"es-ES",text:"Spanish (Spain)"},{value:"es-MX",text:"Spanish (Mexico)"},{value:"fr-FR",text:"French (France)"},{value:"de-DE",text:"German"},{value:"it-IT",text:"Italian"},{value:"pt-PT",text:"Portuguese (Portugal)"},{value:"pt-BR",text:"Portuguese (Brazil)"},{value:"ja-JP",text:"Japanese"},{value:"zh-CN",text:"Chinese (Simplified)"},{value:"other",text:"Other (Specify)"}];let r=!1,i="";e.language&&!a.some(g=>g.value===e.language&&g.value!=="other")&&(r=!0,i=e.language);const m=a.map(g=>`<option value="${g.value}" ${r&&g.value==="other"||!r&&e.language===g.value?"selected":""}>${g.text}</option>`).join("");t.innerHTML=`
        <div class="modal" role="dialog" aria-labelledby="exportModalTitle" aria-modal="true" style="max-width: 500px;">
            <h2 id="exportModalTitle">Export “${e.title||"Untitled Novel"}”</h2>

            <div class="mb-3">
                <label for="exportTitleInput" class="block text-sm font-medium text-color-onSurface mb-1">Book Title</label>
                <input type="text" id="exportTitleInput" value="${e.title||""}" class="w-full p-2 bg-color-input-bg border border-color-border rounded text-color-onSurface">
            </div>

            <div class="mb-3">
                <label for="exportAuthorInput" class="block text-sm font-medium text-color-onSurface mb-1">Author Name</label>
                <input type="text" id="exportAuthorInput" value="${e.author||n.defaultAuthor||""}" class="w-full p-2 bg-color-input-bg border border-color-border rounded text-color-onSurface">
            </div>

            <div class="mb-3">
                <label for="exportLanguageInput" class="block text-sm font-medium text-color-onSurface mb-1">Language</label>
                <select id="exportLanguageInput" class="w-full p-2 bg-color-input-bg border border-color-border rounded text-color-onSurface">
                    ${m}
                </select>
                <input type="text" id="exportLanguageOtherInput" placeholder="e.g., fr-CA, pt-PT" value="${r?i:""}" class="w-full p-2 bg-color-input-bg border border-color-border rounded text-color-onSurface mt-2 ${r?"":"hidden"}">
            </div>

            <div class="mb-4">
                <label for="coverInput" class="block text-sm font-medium text-color-onSurface mb-1">Cover Image (PNG, JPG, max 2MB)</label>
                <div id="coverPreviewContainer" class="mb-2"> <!-- Themed in modals.css -->
                    <img id="coverPreviewImage" src="#" alt="Cover Preview" class="hidden">
                    <div id="coverPreviewPlaceholder">No cover selected.</div>
                </div>
                <input type="file" id="coverInput" accept="image/png, image/jpeg" class="w-full text-sm file:mr-2 file:py-1 file:px-2 file:rounded-md file:border file:border-color-border file:text-sm file:font-semibold file:bg-color-input-bg file:text-color-accent hover:file:bg-color-accent/10">
                <small id="coverFileNameDisplay" class="block text-xs text-color-text-secondary truncate mt-1 mb-0 hidden"></small>
                <button id="removeCoverBtn" class="btn btn-link text-color-error text-xs p-0 mt-1 hidden">Remove Cover</button>
            </div>

            <div class="actions mt-6 flex flex-col gap-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button id="downloadZIPBtn" class="btn btn-primary w-full">ZIP (Markdown)</button>
                    <button id="downloadTXTZipBtn" class="btn btn-primary w-full">ZIP (Plain Text)</button>
                </div>
                <button id="downloadEPUBBtn" class="btn btn-primary w-full">Download EPUB</button>
                <hr class="my-2 border-color-border">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                    <button id="saveNovelDetailsBtn" class="btn btn-secondary w-full">Save Details</button>
                    <button id="closeExportBtn" class="btn btn-secondary w-full">Close</button>
                </div>
            </div>
        </div>
    `,document.body.appendChild(t),document.body.classList.add("body-modal-open"),requestAnimationFrame(()=>t.classList.add("active"));const p=t.querySelector("#exportTitleInput"),l=t.querySelector("#exportAuthorInput"),f=t.querySelector("#exportLanguageInput"),s=t.querySelector("#exportLanguageOtherInput"),c=t.querySelector("#coverInput"),d=t.querySelector("#coverPreviewImage"),u=t.querySelector("#coverPreviewPlaceholder"),h=t.querySelector("#coverFileNameDisplay"),T=t.querySelector("#removeCoverBtn"),v=t.querySelector("#saveNovelDetailsBtn");let L=e.coverDataURL;const ee=g=>{g&&!g.startsWith("data:image/svg+xml")?(d.src=g,d.classList.remove("hidden"),u.classList.add("hidden"),T.classList.remove("hidden")):g&&g.startsWith("data:image/svg+xml")?(d.classList.add("hidden"),u.textContent="SVG cover selected (preview not available).",u.classList.remove("hidden"),T.classList.remove("hidden")):(d.src="#",d.classList.add("hidden"),u.textContent="No cover selected.",u.classList.remove("hidden"),T.classList.add("hidden"),h&&(h.textContent="",h.classList.add("hidden")))};f.addEventListener("change",()=>{f.value==="other"?(s.classList.remove("hidden"),s.focus()):(s.classList.add("hidden"),s.value="")}),f.value==="other"&&s.classList.remove("hidden"),ee(L),c.addEventListener("change",async g=>{const P=g.target.files[0];if(h.textContent="",h.classList.add("hidden"),P){if(P.size>2*1024*1024){await $({title:"File Too Large",message:"Cover image must be less than 2MB.",okText:"OK"}),c.value="";return}h.textContent=P.name,h.classList.remove("hidden"),u.textContent="Processing image...",u.classList.remove("hidden"),d.classList.add("hidden");try{L=await dt(P),ee(L)}catch(I){console.error("Cover processing error:",I),L=e.coverDataURL,ee(L),await $({title:"Image Error",message:"Could not process the selected image.",okText:"OK"}),h.textContent="",h.classList.add("hidden")}}else L=e.coverDataURL,ee(L)}),T.addEventListener("click",()=>{L=null,c.value="",ee(null)});const ae=async()=>{let g=!1;const P=p.value.trim()||"Untitled Novel";P!==e.title&&(e.title=P,g=!0);const I=l.value.trim();I!==e.author&&(e.author=I,g=!0);let b=f.value;return b==="other"&&(b=s.value.trim(),b||(b=e.language||"en-US")),b!==e.language&&(e.language=b,g=!0),L!==e.coverDataURL&&(e.coverDataURL=L,g=!0),g&&(K(e.id),_(w),document.getElementById(xe).innerText=e.title,document.getElementById(Ne)&&(document.getElementById(Ne).innerText=e.title)),g};v.addEventListener("click",async()=>{await ae()?E("Novel details saved ✓","success"):E("No changes to save.","info",1500)}),t.querySelector("#downloadEPUBBtn").addEventListener("click",async()=>{await ae();const g=e.title||"Untitled Novel",P=e.author||n.defaultAuthor||"Unknown Author";let I=e.language||"en-US";I.includes(",")&&(I=I.split(",")[0].trim());const b=e.coverDataURL;try{if(typeof JSZip>"u")throw new Error("JSZip library is not loaded.");const R=new JSZip;R.file("mimetype","application/epub+zip",{compression:"STORE"});const Z=R.folder("OEBPS");R.folder("META-INF").file("container.xml",It()),Z.folder("css").file("style.css",Dt());let re=null;if(b&&!b.startsWith("data:image/svg+xml")){const N=Z.folder("images"),H=b.match(/^data:(image\/(png|jpeg|gif));base64,/);if(H){const it=H[1],st=H[2]==="jpeg"?"jpg":H[2],lt=b.substring(H[0].length),$e=`cover.${st}`;N.file($e,lt,{base64:!0}),Z.file("cover.xhtml",Bt($e,I)),re={filename:$e,mimeType:it,id:"cover-image"}}else console.warn("Could not determine cover image type or invalid data URL."),await $({title:"Cover Warning",message:"Could not process cover image for EPUB. It might be an unsupported format. EPUB will be generated without cover.",okText:"OK"})}else b&&b.startsWith("data:image/svg+xml")&&(console.warn("SVG covers are not reliably supported in EPUB2 and will be skipped."),await $({title:"Cover Warning",message:"SVG cover images are not reliably supported for EPUB export and will be skipped.",okText:"OK"}));const W=e.chapters.slice().sort((N,H)=>N.order-H.order);W.forEach(N=>{const H=X(`chapter-${N.order}_${N.title||"chapter-"+N.order}`)+".xhtml";Z.file(H,Mt(N,I))}),Z.file("content.opf",$t(e,g,P,I,W,re)),Z.file("toc.ncx",Nt(e,g,W));const U=await R.generateAsync({type:"blob",mimeType:"application/epub+zip"}),D=document.createElement("a");D.href=URL.createObjectURL(U),D.download=`${X(g)}.epub`,D.click(),URL.revokeObjectURL(D.href),E("EPUB exported successfully!","success")}catch(R){console.error("EPUB Generation Error:",R),await $({title:"EPUB Export Failed",message:`Could not generate EPUB. ${R.message}. Please check console for details.`,okText:"OK"})}}),t.querySelector("#downloadZIPBtn").addEventListener("click",async()=>{await ae();const g=e.title||"Untitled Novel",P=e.author||n.defaultAuthor||"Unknown Author",I=e.language||"en-US";try{if(typeof JSZip>"u"||typeof TurndownService>"u")throw new Error("JSZip or TurndownService library is not loaded.");const b=new JSZip,R=new TurndownService({headingStyle:"atx",codeBlockStyle:"fenced"}),Z=e.createdAt?new Date(e.createdAt).toLocaleDateString():"N/A",he=e.updatedAt?new Date(e.updatedAt).toLocaleDateString():"N/A",re=`
# ${g}
**Author:** ${P}
**Language:** ${I}
**Created:** ${Z}
**Last Updated:** ${he}
**Total Chapters:** ${e.chapters.length}
---
            `;b.file("novel_metadata.md",re.trim()),e.chapters.sort((D,N)=>D.order-N.order).forEach(D=>{const N=`${String(D.order).padStart(2,"0")}_${X(D.title||`chapter-${D.order}`)}`,H=R.turndown(D.contentHTML||"");b.file(`${N}.md`,H)});const W=await b.generateAsync({type:"blob"}),U=document.createElement("a");U.href=URL.createObjectURL(W),U.download=`${X(g)}.zip`,U.click(),URL.revokeObjectURL(U.href),E("ZIP (MD) exported successfully!","success")}catch(b){console.error("ZIP Generation Error:",b),await $({title:"ZIP Export Failed",message:`Could not generate ZIP archive. ${b.message}. Please check console for details.`,okText:"OK"})}}),t.querySelector("#downloadTXTZipBtn").addEventListener("click",async()=>{await ae();const g=e.title||"Untitled Novel",P=e.author||n.defaultAuthor||"Unknown Author",I=e.language||"en-US";try{if(typeof JSZip>"u")throw new Error("JSZip library is not loaded.");const b=new JSZip,R=e.createdAt?new Date(e.createdAt).toLocaleDateString():"N/A",Z=e.updatedAt?new Date(e.updatedAt).toLocaleDateString():"N/A",he=`Title: ${g}
Author: ${P}
Language: ${I}
Created: ${R}
Last Updated: ${Z}
Total Chapters: ${e.chapters.length}
---
`;b.file("novel_metadata.txt",he),e.chapters.sort((U,D)=>U.order-D.order).forEach(U=>{const D=`${String(U.order).padStart(2,"0")}_${X(U.title||`chapter-${U.order}`)}`,N=ut(U.contentHTML||"");b.file(`${D}.txt`,N)});const re=await b.generateAsync({type:"blob"}),W=document.createElement("a");W.href=URL.createObjectURL(re),W.download=`${X(g)}_txt.zip`,W.click(),URL.revokeObjectURL(W.href),E("ZIP (TXT) exported successfully!","success")}catch(b){console.error("TXT ZIP Generation Error:",b),await $({title:"TXT ZIP Export Failed",message:`Could not generate TXT ZIP archive. ${b.message}. Please check console for details.`,okText:"OK"})}});const Ie=t.querySelector(".modal"),De=Array.from(Ie.querySelectorAll('button, input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(g=>g.offsetParent!==null),fe=De[0]||p,Re=De[De.length-1];fe&&fe.focus();const rt=t.querySelector("#closeExportBtn"),Be=()=>{t.classList.remove("active"),document.body.classList.remove("body-modal-open"),setTimeout(()=>{document.body.contains(t)&&document.body.removeChild(t),o&&typeof o.focus=="function"&&o.focus()},200)},at=g=>{g.key==="Escape"?Be():g.key==="Tab"&&(g.shiftKey?document.activeElement===fe&&(g.preventDefault(),Re.focus()):document.activeElement===Re&&(g.preventDefault(),fe.focus()))};rt.addEventListener("click",Be),t.addEventListener("click",g=>{g.target===t&&Be()}),t.addEventListener("keydown",at)}function Ut(){const e=document.getElementById(ft);e&&!S.app&&(S.app=new Hammer(e),S.app.on("swiperight",()=>{k&&window.innerWidth<768&&!document.getElementById(Y).classList.contains("open")&&Se()}),S.app.on("swipeleft",()=>{k&&window.innerWidth<768&&document.getElementById(Y).classList.contains("open")&&Ae()}))}function nt(){S.editor&&(S.editor.destroy(),S.editor=null)}function Ot(e){if(nt(),e){S.editor=new Hammer(e,{recognizers:[[Hammer.Pinch,{enable:!0}]]});let o=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--editor-font-scale"))||1;S.editor.on("pinchstart",()=>{o=parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--editor-font-scale"))||1}),S.editor.on("pinch",t=>{let n=o*t.scale;n=Math.min(2,Math.max(.75,n)),document.documentElement.style.setProperty("--editor-font-scale",n)})}}function _t(){const e=document.getElementById(pe);e&&!S.chapterList?(S.chapterList=new Hammer(e),S.chapterList.get("press").set({time:600}),S.chapterList.on("press",async o=>{const t=o.target.closest("li[data-chapter-id]");if(!t||!k)return;const n=t.dataset.chapterId,a=w.find(i=>i.id===k);if(!a)return;const r=a.chapters.find(i=>i.id===n);r&&(ie(),Rt(r,o.center.x,o.center.y))})):!e&&S.chapterList&&(S.chapterList.destroy(),S.chapterList=null)}let C=null;function ie(){C&&(document.body.contains(C)&&document.body.removeChild(C),C=null)}async function Rt(e,o,t){ie();const n=w.find(f=>f.id===k);if(!n)return;C=document.createElement("div"),C.id="chapterContextMenu",C.setAttribute("role","menu"),C.setAttribute("aria-label",`Actions for chapter ${e.title}`);const a=n.chapters.findIndex(f=>f.id===e.id),r=a===0,i=a===n.chapters.length-1;C.innerHTML=`
    <div class="menu-item" data-action="rename" role="menuitem" tabindex="0">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2 inline-block align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>Rename
    </div>
    <div class="menu-item ${r?"menu-item-disabled":""}" data-action="moveUp" role="menuitem" tabindex="${r?-1:0}" aria-disabled="${r}">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2 inline-block align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" /></svg>Move Up
    </div>
    <div class="menu-item ${i?"menu-item-disabled":""}" data-action="moveDown" role="menuitem" tabindex="${i?-1:0}" aria-disabled="${i}">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-2 inline-block align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" /></svg>Move Down
    </div>
    <div class="menu-item menu-item-delete" data-action="delete" role="menuitem" tabindex="0">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 mr-2 inline-block align-text-bottom text-color-error"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75H4.5a.75.75 0 0 0 0 1.5h11a.75.75 0 0 0 0-1.5H14A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.531.096 2.182.275a.75.75 0 0 0 .541-.941A4.527 4.527 0 0 0 10 3c-.84 0-1.531.096-2.182.275a.75.75 0 0 0 .541.941A4.527 4.527 0 0 0 10 4ZM4.5 6.5A.75.75 0 0 0 3.75 7.25v7.5A2.75 2.75 0 0 0 6.5 17.5h7a2.75 2.75 0 0 0 2.75-2.75v-7.5A.75.75 0 0 0 15.5 6.5h-11Z" clip-rule="evenodd" /></svg>Delete
    </div>
  `,document.body.appendChild(C),C.style.left=`${Math.min(o,window.innerWidth-C.offsetWidth-10)}px`,C.style.top=`${Math.min(t,window.innerHeight-C.offsetHeight-10)}px`;const m=C.querySelector('[role="menuitem"][tabindex="0"]');m&&m.focus();const p=async f=>{var d;const s=n.chapters.findIndex(u=>u.id===e.id);let c=null;switch(f){case"rename":const u=await ge({title:"Rename Chapter",initialValue:e.title,placeholder:"Enter new chapter title..."});u!==null&&u!==e.title&&(e.title=u||"Untitled Chapter",e.updatedAt=new Date().toISOString(),K(n.id),_(w),E("Chapter renamed","success"),q(n),x===e.id&&document.getElementById(ce)&&(document.getElementById(ce).textContent=e.title));break;case"delete":if(await $({title:"Delete Chapter",message:`Are you sure you want to delete chapter “${e.title||"Untitled Chapter"}”?`,okText:"Delete"})){const T=x===e.id;T&&(A=!1),n.chapters.splice(s,1),se(n.chapters),K(n.id),_(w),E("Chapter deleted","success"),q(n),ot(),T&&(x=((d=n.chapters.sort((v,L)=>v.order-L.order)[0])==null?void 0:d.id)||null,te(n.id,x),x?await le(n.chapters.find(v=>v.id===x)):Te())}break;case"moveUp":s>0&&([n.chapters[s-1],n.chapters[s]]=[n.chapters[s],n.chapters[s-1]],se(n.chapters),K(n.id),_(w),q(n),c=e.id);break;case"moveDown":s<n.chapters.length-1&&([n.chapters[s+1],n.chapters[s]]=[n.chapters[s],n.chapters[s+1]],se(n.chapters),K(n.id),_(w),q(n),c=e.id);break}if(ie(),c){const u=document.querySelector(`#${pe} li[data-chapter-id="${c}"]`);u&&u.focus()}};C.addEventListener("click",f=>{const s=f.target.closest(".menu-item");s&&!s.classList.contains("menu-item-disabled")&&p(s.dataset.action)}),C.addEventListener("keydown",f=>{const s=f.target.closest(".menu-item");if(s&&(f.key==="Enter"||f.key===" ")&&!s.classList.contains("menu-item-disabled"))f.preventDefault(),p(s.dataset.action);else if(f.key==="Escape")ie();else if(f.key==="ArrowDown"||f.key==="ArrowUp"){f.preventDefault();const c=Array.from(C.querySelectorAll('[role="menuitem"]:not([aria-disabled="true"])'));let d=c.indexOf(document.activeElement);f.key==="ArrowDown"?d=(d+1)%c.length:d=(d-1+c.length)%c.length,c[d]&&c[d].focus()}});const l=f=>{C&&!C.contains(f.target)&&(ie(),document.removeEventListener("click",l,!0))};setTimeout(()=>document.addEventListener("click",l,!0),0)}function ot(){if(document.getElementById(Y).offsetParent===null)return;if(x){const t=document.querySelector(`#${pe} li[data-chapter-id="${x}"]`);if(t){t.focus();return}}const o=document.getElementById(be);o&&o.focus()}/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
